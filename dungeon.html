<!DOCTYPE html>
<head>
    <title>Silly Peter Increases G Two - Dungeon Screen</title>
    <div id="screen">
      <img id="screen-image" src="images/test_cliff.png" />
    </div>
    <link rel="stylesheet" type="text/css" href="dungeon-page-style.css" />
  </head>
  <body>
    <button id="left-button" onclick="player.goLeft ()">Left</button>
    <button id="right-button" onclick="player.goRight ()">Right</button>
    <button id="forward-button" onclick="onForward()">Go forward</button>
    <button id="compass" onclick="compass()">Compass</button>
    <button id="back-to-campus" onclick="gotoCampus()">Back to campus</button>
    
    <p id="floor-text">Floor 1</p>

    <p id="description-text"></p>
<script src="player.js"></script>
<script src="map.js"></script>
<script src="statuses.js"></script>
<script src="skills.js"></script>
<script src="items.js"></script>
<script src="entities.js"></script>
<script src="dataStorage.js"></script>
<script>
    let ENCOUNTER_RATE = 15;

    let myAudio = document.createElement("audio");
    myAudio.src = "audio/other_world.mp3";
    myAudio.loop = true;

    let party = getParty ();
    updateDungeonInfo ();

    function onForward() {
        player.goForward (); 
        myAudio.play();
    }

    function updateImage() {
        let roomIndex = 0;
        if (player.direction === "west") {
            if (player.x === 0) {
              document.getElementById("screen-image").src = "images/test_cliff.png";
            } else {
              roomIndex = getIndexFromPosition(player.x - 1, player.y);
              document.getElementById("screen-image").src = dungeon.map[roomIndex].image;
            }
        } else if (player.direction === "north") {
            if (player.y === 0) {
                document.getElementById("screen-image").src = "images/test_cliff.png";
            } else {
                roomIndex = getIndexFromPosition(player.x, player.y - 1);
                document.getElementById("screen-image").src = dungeon.map[roomIndex].image;
            }
        } else if (player.direction === "east") {
            if (player.x === MAP_SIZE - 1) {
                document.getElementById("screen-image").src = "images/test_cliff.png";
            } else {
                roomIndex = getIndexFromPosition(player.x + 1, player.y);
                document.getElementById("screen-image").src = dungeon.map[roomIndex].image;
            }
        } else if (player.direction === "south") {
            if (player.y === MAP_SIZE - 1) {
                document.getElementById("screen-image").src = "images/test_cliff.png";
            } else {
                roomIndex = getIndexFromPosition(player.x, player.y + 1);
                document.getElementById("screen-image").src = dungeon.map[roomIndex].image;
            }
        }
    }

    updateImage ();

    function checkForEncounter () {
        let randomNumber = Math.floor(Math.random() * 101);
        if (randomNumber <= ENCOUNTER_RATE) {
            battle ();
        }
    }
    function battle () {
        let enemyIndices = generateEnemies ();
        saveDungeonState ();
        saveEncounter (enemyIndices);
        document.getElementById("description-text").innerHTML = "You encounter an enemy!";
        setTimeout(function () { window.location.replace('battle.html'); }, 1000);
    }
    function generateEnemies () {
        let enemies = [];
        let numberOfEnemies = Math.floor(Math.random() * 3) + 1;

        for (let i = 0; i < numberOfEnemies; i++) {
            if (player.floor < 5) {
                let enemyIndex = Math.floor(Math.random() * 2);
                enemies.push(enemyIndex);
            }
        }
        return enemies;
    }

    function updateDungeonInfo () {
        let dungeonState = getDungeonState();
        if (dungeonState === undefined) {
            dungeon.generateFloor();
        } else {
            player.direction = dungeonState.player.direction;
            player.floor = dungeonState.player.floor;
            player.x = dungeonState.player.x;
            player.y = dungeonState.player.y;
            document.getElementById("floor-text").innerHTML = "Floor " + player.floor;

            dungeon.map = dungeonState.dungeon.map;
            dungeon.treasureChests = dungeonState.dungeon.treasureChests;
            dungeon.stairs = dungeonState.dungeon.stairs;
        }
    }

    function compass () {
        document.getElementById("description-text").innerHTML = "You are facing " + player.direction + ".";
    }

    let gotoCampus = function () {
        localStorage.removeItem("dungeon-data");
        window.location.replace('campus.html'); 
    }
</script>
</body>
</html>
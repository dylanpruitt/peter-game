<!DOCTYPE html>
<head>
    <title>Silly Peter Increases G Two - Victory Screen</title>
    <link rel="stylesheet" type="text/css" href="battle-page-style.css" />
    <h1>Victory</h1>
    <hr>
</head>
<body>
    <p>You won the battle!</p>
    <button id="see-results" onclick="battleResults()">See results</button>

    <script src="skills.js"></script>
    <script src="items.js"></script>
    <script src="entities.js"></script>
    <script src="dataStorage.js"></script>
    <script>
        players = getParty();
        let gameData = getBattleState();
        let enemies = gameData.enemies;

        let expToNextLevel = [80, 175, 285, 410, 550, 705, 875, 1060, 1260];

        let myAudio = document.createElement("audio");
        myAudio.src = "audio/level_up.mp3";
        myAudio.loop = true;

        let calculateExperienceGain = function (player) {
            let experienceGain = 0;
            for (let i = 0; i < enemies.length; i++) {
                let experience = enemies [i].experience - (player.level * 4);
                if (experience < 0) { experience = 0; }
                experienceGain += experience;
            }
            return experienceGain;
        }

        let promotePlayer = function (player) {
            let levelUpStrings = ["Gnarly! ", "Radical! ", "Tubular! ", "Totally Based! ", "Awesome! "];
            let levelUpString = levelUpStrings[Math.floor(Math.random() * levelUpStrings.length)];

            myAudio.play();
            player.level++;
            let levelUpText = document.createElement ("p");
            levelUpText.innerHTML = levelUpString + player.name + " has been promoted to level <span style='color: coral'>"
                 + player.level + "</span>!";
            document.body.appendChild (levelUpText); 

            if (player.name === "Peter") {
                player.maxHealth += Math.floor (Math.random() * 11);
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 3) + 2;
                player.defense += Math.floor (Math.random() * 2) + 1;
                player.evasion += Math.floor (Math.random() * 5) + 1;
                updatePeterSkills (player);
            } else if (player.name === "Raymond") {
                player.maxHealth += Math.floor (Math.random() * 10);
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 3);
                player.defense += Math.floor (Math.random() * 2);
                player.evasion += Math.floor (Math.random() * 3);
                updateRaymondSkills (player);
            } else if (player.name === "Hunter") {
                player.maxHealth += Math.floor (Math.random() * 9);
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 5);
                player.defense += Math.floor (Math.random() * 3);
                player.evasion += Math.floor (Math.random() * 4);
                updateHunterSkills (player);
            } else if (player.name === "Abby") {
                player.maxHealth += Math.floor (Math.random() * 7);
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 4);
                player.defense += Math.floor (Math.random() * 2);
                player.evasion += Math.floor (Math.random() * 4);
                updateAbbySkills (player);
            } else if (player.name === "Joe") {
                player.maxHealth += Math.floor (Math.random() * 8);
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 3);
                player.defense += Math.floor (Math.random() * 3);
                player.evasion += Math.floor (Math.random() * 3);
                updateJoeSkills (player);
            } else if (player.name === "Justin") {
                player.maxHealth += Math.floor (Math.random() * 6);
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 4);
                player.defense += Math.floor (Math.random() * 2);
                player.evasion += Math.floor (Math.random() * 5);
                updateJustinSkills (player);
            }
        }

        let updatePeterSkills = function (player) {
            let hasLearnedSkill = false;
            if (player.level === 2) {
                player.skills.push (provoke ());
                hasLearnedSkill = true;
            }
            if (hasLearnedSkill) {
                let skillAwardText = document.createElement ("p");
                skillAwardText.innerHTML = player.name + " has learned a new skill!";
                document.body.appendChild (skillAwardText); 
            }
        }
        let updateRaymondSkills = function (player) {

        }
        let updateHunterSkills = function (player) {
            let hasLearnedSkill = false;
            if (player.level === 2) {
                player.skills.push (caffeine ());
                hasLearnedSkill = true;
            }
            if (hasLearnedSkill) {
                let skillAwardText = document.createElement ("p");
                skillAwardText.innerHTML = player.name + " has learned a new skill!";
                document.body.appendChild (skillAwardText); 
            }
        }
        let updateAbbySkills = function (player) {

        }
        let updateJoeSkills = function (player) {
            let hasLearnedSkill = false;
            if (player.level === 2) {
                player.skills.push (lightning ());
                hasLearnedSkill = true;
            }
            if (hasLearnedSkill) {
                let skillAwardText = document.createElement ("p");
                skillAwardText.innerHTML = player.name + " has learned a new skill!";
                document.body.appendChild (skillAwardText); 
            }
        }
        let updateJustinSkills = function (player) {
            let hasLearnedSkill = false;
            if (player.level === 2) {
                player.skills.push (charm ());
                hasLearnedSkill = true;
            }
            if (hasLearnedSkill) {
                let skillAwardText = document.createElement ("p");
                skillAwardText.innerHTML = player.name + " has learned a new skill!";
                document.body.appendChild (skillAwardText); 
            }
        }

        let playerReadyForPromotion = function (player) {
            if (player.experience >= expToNextLevel[player.level - 1]) {
                return true;
            } else {
                return false;
            }
        }

        let battleResults = function () {
            document.getElementById("see-results").style.visibility = "hidden";
            for (let i = 0; i < players.length; i++) {
                let experienceGain = calculateExperienceGain (players [i]);
                players [i].experience += experienceGain;
                let experienceGainText = document.createElement ("p");
                experienceGainText.innerHTML = players [i].name + " gained <span style='color: coral'>" 
                    + experienceGain + "</span> EXP!";
                document.body.appendChild (experienceGainText); 
                if (playerReadyForPromotion (players [i])) {
                    promotePlayer (players [i]);
                } else {
                    let experienceToNextLevel = expToNextLevel [players [i].level - 1] - players [i].experience;
                    let expToNextText = document.createElement ("p");
                    expToNextText.innerHTML = "<span style='color: coral'>" + experienceToNextLevel + "</span> EXP to next level";
                    document.body.appendChild (expToNextText); 
                }
            }
            
            enemies.length = 0;
            saveBattleState();
            saveParty(players);

            let backToDungeonButton = document.createElement ("button");
            backToDungeonButton.className = "back-to-dungeon";
            backToDungeonButton.onclick = function () { window.location.replace('dungeon.html'); };
            backToDungeonButton.innerHTML = "Back to dungeon";
            document.body.appendChild(backToDungeonButton);
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<head>
    <title>Silly Peter Increases G Two - Victory Screen</title>
    <link rel="stylesheet" type="text/css" href="battle-page-style.css" />
    <h1>Victory</h1>
    <hr>
</head>
<body>
    <p>You won the battle!</p>
    <button id="see-results" onclick="battleResults()">See results</button>

    <script src="skills.js"></script>
    <script src="items.js"></script>
    <script src="entities.js"></script>
    <script src="dataStorage.js"></script>
    <script>
        players = getParty();
        let gameData = getBattleState();
        let enemies = gameData.enemies;
        let unselectedMembers = [playerAbby(), playerJoe()];
        let memberData = getUnselectedMembers();
        if (memberData !== undefined) {
            unselectedMembers = memberData;
        }

        let expToNextLevel = [80, 175, 285, 410, 550, 705, 875, 1060, 1260];

        let myAudio = document.createElement("audio");
        myAudio.src = "audio/level_up.mp3";
        myAudio.loop = true;

        if (enemies.length > 0) {
            if (enemies [0].isBoss) { players [0].bossesDefeated++; }
        }

        let calculateExperienceGain = function (player) {
            let experienceGain = 0;
            for (let i = 0; i < enemies.length; i++) {
                let experience = enemies [i].experience - (player.level * 4);
                if (experience < 0) { experience = 0; }
                experienceGain += experience;
            }
            return experienceGain;
        }

        let promotePlayer = function (player) {
            let levelUpStrings = ["Gnarly! ", "Radical! ", "Tubular! ", "Totally Based! ", "Awesome! "];
            let levelUpString = levelUpStrings[Math.floor(Math.random() * levelUpStrings.length)];

            myAudio.play();
            player.level++;
            let levelUpText = document.createElement ("p");
            levelUpText.innerHTML = levelUpString + player.name + " has been promoted to level <span style='color: coral'>"
                 + player.level + "</span>!";
            document.body.appendChild (levelUpText); 

            if (player.name === "Peter") {
                player.maxHealth += Math.floor (Math.random() * 6) + 5;
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 3) + 2;
                player.defense += Math.floor (Math.random() * 2) + 1;
                player.evasion += Math.floor (Math.random() * 5) + 1;
                updatePeterSkills (player);
            } else if (player.name === "Raymond") {
                player.maxHealth += Math.floor (Math.random() * 7) + 3;
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 4) + 1;
                player.defense += Math.floor (Math.random() * 3) + 1;
                player.evasion += Math.floor (Math.random() * 4) + 1;
                updateRaymondSkills (player);
            } else if (player.name === "Hunter") {
                player.maxHealth += Math.floor (Math.random() * 6) + 3;
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 4) + 1;
                player.defense += Math.floor (Math.random() * 2) + 1;
                player.evasion += Math.floor (Math.random() * 3) + 1;
                updateHunterSkills (player);
            } else if (player.name === "Abby") {
                player.maxHealth += Math.floor (Math.random() * 4) + 3;
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 3) + 1;
                player.defense += Math.floor (Math.random() * 2);
                player.evasion += Math.floor (Math.random() * 4) + 1;
                updateAbbySkills (player);
            } else if (player.name === "Joe") {
                player.maxHealth += Math.floor (Math.random() * 3) + 5;
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 2) + 1;
                player.defense += Math.floor (Math.random() * 2) + 1;
                player.evasion += Math.floor (Math.random() * 3) + 1;
                updateJoeSkills (player);
            } else if (player.name === "Justin") {
                player.maxHealth += Math.floor (Math.random() * 6);
                player.health = player.maxHealth;
                player.attack += Math.floor (Math.random() * 2) + 2;
                player.defense += Math.floor (Math.random() * 2);
                player.evasion += Math.floor (Math.random() * 2) + 4;
                updateJustinSkills (player);
            }
        }

        let updatePeterSkills = function (player) {
            let hasLearnedSkill = false;
            if (player.level === 2) {
                player.skills.push (provoke ());
                hasLearnedSkill = true;
            }
            if (player.level === 3) {
                player.skills.push (lightning2 ());
                hasLearnedSkill = true;
            }
            if (player.level === 4) {
                playerReplaceSkill (player, resistIce());
            }
            if (player.level === 5) {
                playerReplaceSkill (player, gambleHP());
            }
            if (hasLearnedSkill) {
                let skillAwardText = document.createElement ("p");
                skillAwardText.innerHTML = player.name + " has learned a new skill!";
                document.body.appendChild (skillAwardText); 
            }
        }
        let updateRaymondSkills = function (player) {
            let hasLearnedSkill = false;
            if (player.level === 2) {
                player.skills.push (gravity ());
                hasLearnedSkill = true;
            }
            if (player.level === 3) {
                player.skills.push (boostAttack ());
                hasLearnedSkill = true;
            }
            if (player.level === 4) {
                playerReplaceSkill (player, boostDefense());
            }
            if (player.level === 5) {
                playerReplaceSkill (player, resistFire());
            }
            if (hasLearnedSkill) {
                let skillAwardText = document.createElement ("p");
                skillAwardText.innerHTML = player.name + " has learned a new skill!";
                document.body.appendChild (skillAwardText);
            }
        }
        let updateHunterSkills = function (player) {
            let hasLearnedSkill = false;
            if (player.level === 2) {
                player.skills.push (caffeine ());
                hasLearnedSkill = true;
            }
            if (player.level === 3) {
                player.skills.push (boostDefense ());
                hasLearnedSkill = true;
            }
            if (player.level === 4) {
                playerReplaceSkill (player, resistIce());
            }
            if (hasLearnedSkill) {
                let skillAwardText = document.createElement ("p");
                skillAwardText.innerHTML = player.name + " has learned a new skill!";
                document.body.appendChild (skillAwardText);
            }
        }
        let updateAbbySkills = function (player) {
            let hasLearnedSkill = false;
            if (player.level === 2) {
                player.skills.push (fire ());
                hasLearnedSkill = true;
            }
            if (player.level === 3) {
                player.skills.push (decharm ());
                hasLearnedSkill = true;
            }
            if (player.level === 4) {
                playerReplaceSkill (player, resistLightning());
            }
            if (player.level === 5) {
                playerReplaceSkill (player, slowDown());
            }
            if (hasLearnedSkill) {
                let skillAwardText = document.createElement ("p");
                skillAwardText.innerHTML = player.name + " has learned a new skill!";
                document.body.appendChild (skillAwardText); 
            }
        }
        let updateJoeSkills = function (player) {
            let hasLearnedSkill = false;
            if (player.level === 2) {
                player.skills.push (lightning ());
                hasLearnedSkill = true;
            }
            if (player.level === 3) {
                player.skills.push (boostDefense ());
                hasLearnedSkill = true;
            }
            if (player.level === 4) {
                playerReplaceSkill (player, barrage());
            }
            if (player.level === 5) {
                playerReplaceSkill (player, resistLightning());
            }
            if (hasLearnedSkill) {
                let skillAwardText = document.createElement ("p");
                skillAwardText.innerHTML = player.name + " has learned a new skill!";
                document.body.appendChild (skillAwardText); 
            }
        }
        let updateJustinSkills = function (player) {
            let hasLearnedSkill = false;
            if (player.level === 2) {
                player.skills.push (charm ());
                hasLearnedSkill = true;
            }
            if (player.level === 3) {
                player.skills.push (boostAttack ());
                hasLearnedSkill = true;
            }
            if (player.level === 4) {
                playerReplaceSkill (player, resistFire());
            }
            if (player.level === 5) {
                playerReplaceSkill (player, resistIce());
            }
            if (hasLearnedSkill) {
                let skillAwardText = document.createElement ("p");
                skillAwardText.innerHTML = player.name + " has learned a new skill!";
                document.body.appendChild (skillAwardText); 
            }
        }

        let playerReadyForPromotion = function (player) {
            if (player.experience >= expToNextLevel[player.level - 1]) {
                return true;
            } else {
                return false;
            }
        }

        let battleResults = function () {
            document.getElementById("see-results").style.visibility = "hidden";
            for (let i = 0; i < players.length; i++) {
                let experienceGain = calculateExperienceGain (players [i]);
                players [i].experience += experienceGain;
                let experienceGainText = document.createElement ("p");
                experienceGainText.innerHTML = players [i].name + " gained <span style='color: coral'>" 
                    + experienceGain + "</span> EXP!";
                document.body.appendChild (experienceGainText); 
                if (playerReadyForPromotion (players [i])) {
                    promotePlayer (players [i]);
                } else {
                    let experienceToNextLevel = expToNextLevel [players [i].level - 1] - players [i].experience;
                    let expToNextText = document.createElement ("p");
                    expToNextText.innerHTML = "<span style='color: coral'>" + experienceToNextLevel + "</span> EXP to next level";
                    document.body.appendChild (expToNextText); 
                }
            }
            for (let i = 0; i < unselectedMembers.length; i++) {
                let experienceGain = calculateExperienceGain (unselectedMembers [i]);
                let MODIFIER = 0.75;
                unselectedMembers [i].experience += Math.floor (MODIFIER * experienceGain);
            }
            enemies.length = 0;
            saveBattleState();
            saveParty(players);
            saveUnselectedMembers(unselectedMembers);

            let backToDungeonButton = document.createElement ("button");
            backToDungeonButton.className = "back-to-dungeon";
            backToDungeonButton.onclick = function () { 
                saveParty(players);
                window.location.replace('dungeon.html'); 
            };
            backToDungeonButton.innerHTML = "Back to dungeon";
            document.body.appendChild(backToDungeonButton);
        }

        let playerReplaceSkill = function (player, skill) {
            let text = document.createElement ("p");
            text.innerHTML = "Replace which skill?";
            document.body.appendChild(text);
            for (let i = 0; i < player.skills.length; i++) {
                let skillReplaceButton = document.createElement ("button");
                skillReplaceButton.className = "replace-skill-" + player.name;
                skillReplaceButton.onclick = function () { replaceSkill (player, i, skill); };
                skillReplaceButton.innerHTML = player.skills [i].name;
                skillReplaceButton.title = player.skills [i].description;
                document.body.appendChild(skillReplaceButton);
            }

            let forgetSkillButton = document.createElement ("button");
            forgetSkillButton.className = "forget-skill-" + player.name;
            forgetSkillButton.onclick = function () {
                let buttons = document.getElementsByClassName("replace-skill-" + player.name);

                while (buttons[0]) {
                    buttons[0].parentNode.removeChild(buttons[0]);
                }
                let forgetButtons = document.getElementsByClassName("forget-skill-" + player.name);
                forgetButtons[0].parentNode.removeChild(forgetButtons[0]);
            };
            forgetSkillButton.innerHTML = "Forget skill " + skill.name;
            forgetSkillButton.title = skill.description;
            document.body.appendChild(forgetSkillButton);

            document.body.appendChild(document.createElement ("br"));

        }

        let replaceSkill = function (player, skillIndex, newSkill) {
            player.skills [skillIndex] = newSkill;
            let skillAwardText = document.createElement ("p");
            skillAwardText.innerHTML = player.name + " has learned a new skill!";
            document.body.appendChild (skillAwardText); 

            let buttons = document.getElementsByClassName("replace-skill-" + player.name);

            while (buttons[0]) {
                buttons[0].parentNode.removeChild(buttons[0]);
            }
            let forgetButtons = document.getElementsByClassName("forget-skill-" + player.name);
            forgetButtons[0].parentNode.removeChild(forgetButtons[0]);
        }
    </script>
</body>
</html>